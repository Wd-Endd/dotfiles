#!/usr/bin/env python
import os
import signal
from datetime import datetime
import subprocess
import sys
from pathlib import Path

save_dir = Path(sys.argv[1])
p_file = save_dir / ".recording"

def handle_sigint(signum, frame):
    os.kill(pid, signal.SIGINT)
    with open(p_file, "w") as f:
        f.write("writing...")

if  not p_file.exists():
    date = datetime.now()
    video_name = date.strftime("%Y_%m_%d_%H_%M_%S")
    ogv_name = f".{video_name}"
    ogv_path = str(save_dir / f"{ogv_name}.ogv")
    mp4_path = str(save_dir / f"{video_name}.mp4")

    # record = subprocess.Popen(["sleep", "1000"])
    record = subprocess.Popen(
        ["recordmydesktop", "-o", f"{ogv_path}"],
        stdin=subprocess.PIPE,
    )
    pid = record.pid

    Path(p_file).touch
    with open(p_file, "w") as f:
        f.write(str(pid))

    signal.signal(signal.SIGINT, handle_sigint)
    record.wait()

    convert = subprocess.Popen(
        ["ffmpeg", "-i", ogv_path, "-c:v", "libx264", "-r", "60", "-c:a", "aac", mp4_path],
        stdin=subprocess.PIPE,
    )
    with open(p_file, "w") as f:
        f.write("washing...")

    convert.wait()
    os.remove(p_file)
    os.remove(ogv_path)
    print("True Done!")
else:
    with open(p_file) as f:
        data = f.read().strip()
        pid = int(data)
        os.kill(pid, signal.SIGINT)
        f.close()
    with open(p_file, "w") as f:
        f.write("writing...")
